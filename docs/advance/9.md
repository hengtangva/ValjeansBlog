# CDN 原理

CDN :Content Distribution Network, 即内容分发网络。    

目的是，把服务器的资源分发给多个服务器。好处有    

1. 缓解源服务器的工作量。    

2. 如果请求放距离源服务器很远的话，可能要延迟很久，选择就近的 cdn 服务器可以加快请求。    

3. 缓解甚至消除了不同运营商之间互联的瓶颈造成的影响

来看图吧：    

![](./assets/cdn1.jpg)    

## CDN 工作原理

复习之前，建议过一遍 CDN 原理，    

我们把源服务器的资源分发给各个 CDN服务器，又不想影响用户，最简单的办法，就是在 DNS 解析的时候重定向。     

先看图：    

![](./assets/cdn2.jpg)     

- GSLB: 全局负载均衡系统。    

- SLB：本地负载均衡系统。    

- 缓存服务器：即我们源服务器分发的 CDN 服务器了。    

我们以请求 join.qq.com/hello.html 为例子。    

1. DNS 客户端从浏览器那拿到主机名，发给本地DNS服务器。    

2. 本地服务器将其发送给根服务器(没有缓存的话)，根服务器返回顶级域名服务器 .com 的 ip。    

3. 本地 DNS 服务器拿到后，请求.com ，返回权威服务器 qq.com 的  ip。    

4. 拿到该 ip 后请求 权威服务器，权威服务器开始查找。    

    - 找到一条 CNAME 记录，name = join.qq.com, value = join.qq.cdn.com ;     
    - 还找到一条 A 记录，name = join.qq.cdn.com, value = GSLB 的 ip 地址。     

5. 本地DNS 向 GLSB 发送 DNS 查询报文     

6. GLSB 根据本地DNS 判断用户大概来自深圳，筛选出华南地区综合考量最优的 SLB 的 ip 返回 。    

7. 本地DNS 将上一步的 ip 作为最终 查询结果返回给 CDN客户端，再给浏览器。    

8. 浏览器访问 SLB, SLB 筛选出最佳的 CDN 服务器，后回应客户端的 HTTP 请求，(z状态码为 302，重定向至该最佳 CDN 服务器)    

9. 该 CDN 服务器判断资源是否存在，是否过期，再把资源直接个诶客户端，否则就去源站更新内容。    

参考：https://juejin.cn/post/6844903873518239752



